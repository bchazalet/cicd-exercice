steps:
- name: "gcr.io/cloud-builders/docker"
  args: [
    "build",
    "-t",
    "europe-west2-docker.pkg.dev/cicd-exercise-boris-e8h3/docker-repository/cicd-exercise:latest",
    "-t",
    "europe-west2-docker.pkg.dev/cicd-exercise-boris-e8h3/docker-repository/cicd-exercise:$SHORT_SHA",
    "."
  ]

- name: 'gcr.io/cloud-builders/docker'
args: [
  'push', 
  '-a', 
  'europe-west2-docker.pkg.dev/cicd-exercise-boris-e8h3/docker-repository/cicd-exercise'
]

- name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
  entrypoint: gcloud
  args:
  - 'run'
  - 'deploy'
  - 'cicd-exercise-staging'
  - '--project'
  - 'cicd-exercise-boris-e8h3'
  - '--image'
  - 'europe-west2-docker.pkg.dev/cicd-exercise-boris-e8h3/docker-repository/cicd-exercise:$SHORT_SHA'
  - '--region'
  - 'europe-west2'
  - '--allow-unauthenticated'
  - '--max-instances'
  - '1'

options:
  logging: "CLOUD_LOGGING_ONLY"